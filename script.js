(()=>{const DPI=300,W=3300,H=2550,COLS=4,ROWS=2,CARD_W=750,CARD_H=1050,MARGIN_X=150,MARGIN_Y=225,FN_BASE='/.netlify/functions/swu';const $=id=>document.getElementById(id);const canvas=$('sheet'),ctx=canvas.getContext('2d'),cardList=$('cardList'),showGuides=$('showGuides'),status=$('status'),sheetLabel=$('sheetLabel'),btnBuild=$('btnBuild'),btnExport=$('btnExport'),btnPrint=$('btnPrint'),prev=$('prevSheet'),next=$('nextSheet'),templateFile=$('templateFile');let pages=[[]],pageIdx=0,bakedTemplate=null,userTemplate=null;function log(s){status.textContent=s}function slots(){const aW=W-2*MARGIN_X,aH=H-2*MARGIN_Y,gx=(aW-COLS*CARD_W)/(COLS-1),gy=(aH-ROWS*CARD_H)/(ROWS-1),r=[];for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++)r.push({x:Math.round(MARGIN_X+x*(CARD_W+gx)),y:Math.round(MARGIN_Y+y*(CARD_H+gy)),w:CARD_W,h:CARD_H});return r}function clear(){ctx.fillStyle='#fff';ctx.fillRect(0,0,W,H)}function drawTemplate(){const i=userTemplate||bakedTemplate;if(i)ctx.drawImage(i,0,0,W,H)}function drawGuides(){if(!showGuides.checked)return;ctx.save();ctx.strokeStyle='rgba(59,130,246,.6)';ctx.lineWidth=3;for(const r of slots())ctx.strokeRect(r.x,r.y,r.w,r.h);ctx.restore()}function cover(img,r){const s=Math.min(r.w/img.width,r.h/img.height),dw=img.width*s,dh=img.height*s,dx=r.x+(r.w-dw)/2,dy=r.y+(r.h-dh)/2;ctx.drawImage(img,dx,dy,dw,dh)}function render(){clear();drawTemplate();const rects=slots(),imgs=pages[pageIdx]||[];for(let i=0;i<Math.min(rects.length,imgs.length);i++)cover(imgs[i],rects[i]);drawGuides();sheetLabel.textContent=`Sheet ${pageIdx+1} of ${pages.length}`}async function loadImage(src){const img=new Image();img.crossOrigin='anonymous';img.src=src;await img.decode();return img}async function resolveURL(name){const q=encodeURIComponent(`name:"${name}"`),u=`${FN_BASE}?path=/cards/search&q=${q}`,res=await fetch(u);if(!res.ok)throw new Error('proxy search failed');const data=await res.json(),hit=(data?.data||[])[0];if(!hit)throw new Error('no match');if(hit.FrontArt)return hit.FrontArt;if(hit.Set&&hit.Number)return `${FN_BASE}?path=/cards/${encodeURIComponent(String(hit.Set).toLowerCase())}/${encodeURIComponent(hit.Number)}&format=image`;throw new Error('no image')}function parseList(t){return(t||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean).flatMap(l=>{const m=l.match(/^(.*?)(?:\s+x(\d+))?$/i),n=(m?.[1]||l).trim(),q=Math.max(1,parseInt(m?.[2]||'1',10));return Array(q).fill(n)})}async function build(){log('Buildingâ€¦');const names=parseList(cardList.value),per=COLS*ROWS,chunks=[];for(let i=0;i<names.length;i+=per)chunks.push(names.slice(i,i+per));pages=[];for(const chunk of chunks){const imgs=[];for(const name of chunk){try{const url=await resolveURL(name);imgs.push(await loadImage(url))}catch(e){const ph=document.createElement('canvas');ph.width=CARD_W;ph.height=CARD_H;const c=ph.getContext('2d');c.fillStyle='#fee2e2';c.fillRect(0,0,ph.width,ph.height);c.fillStyle='#991b1b';c.font='28px system-ui,Segoe UI,Roboto';c.fillText('Failed:',16,36);c.font='24px system-ui,Segoe UI,Roboto';c.fillText(name,16,66);imgs.push(ph)}render()}pages.push(imgs)}if(!pages.length)pages=[[]];pageIdx=0;render();log('Done.')}btnBuild.addEventListener('click',build);btnExport.addEventListener('click',()=>{canvas.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`swu_sheet_${pageIdx+1}.png`;a.click();setTimeout(()=>URL.revokeObjectURL(a.href),3e3)})});btnPrint.addEventListener('click',()=>window.print());prev.addEventListener('click',()=>{if(pageIdx>0){pageIdx--;render()}});next.addEventListener('click',()=>{if(pageIdx<pages.length-1){pageIdx++;render()}});showGuides.addEventListener('change',render);templateFile.addEventListener('change',async e=>{const f=e.target.files?.[0];if(!f){userTemplate=null;return render()}const u=URL.createObjectURL(f),img=new Image();img.src=u;await img.decode();userTemplate=img;URL.revokeObjectURL(u);render()});(async()=>{canvas.width=W;canvas.height=H;try{bakedTemplate=await loadImage('assets/template_resized_1056x816.png')}catch{bakedTemplate=null}render()})()})();